#!/usr/bin/env bash

#######################################
# lvsk-calendar - Minimalist aesthetic calendar
# Ultra-clean design with pastel monochromatic palette
#
# Architecture:
#   - Modular design with separated concerns
#   - Clean component-based UI rendering
#   - Pure bash techniques where possible
#######################################

# Strict mode for better error handling
# Note: errexit disabled as many bash idioms return non-zero intentionally
set -o nounset
set -o pipefail

#######################################
# Determine script directory
# Handles both development and installed paths
# Globals:
#   SCRIPT_DIR - Set to script's directory
#   SRC_DIR - Set to source files directory
#######################################
_init_paths() {
    # Get the real path of the script, following symlinks
    local source="${BASH_SOURCE[0]}"
    while [[ -L "$source" ]]; do
        SCRIPT_DIR="$(cd -P "$(dirname "$source")" && pwd)"
        source="$(readlink "$source")"
        [[ "$source" != /* ]] && source="${SCRIPT_DIR}/${source}"
    done
    SCRIPT_DIR="$(cd -P "$(dirname "$source")" && pwd)"

    # Check for development vs installed
    if [[ -d "${SCRIPT_DIR}/src" ]]; then
        SRC_DIR="${SCRIPT_DIR}/src"
    else
        SRC_DIR="/usr/share/lvsk-calendar/src"
    fi
}

# Initialize paths
declare -g SCRIPT_DIR=""
declare -g SRC_DIR=""
_init_paths

# Source all modules in dependency order
# shellcheck source=src/config.sh
source "${SRC_DIR}/config.sh"
# shellcheck source=src/utils.sh
source "${SRC_DIR}/utils.sh"
# shellcheck source=src/holidays.sh
source "${SRC_DIR}/holidays.sh"
# shellcheck source=src/ui/background.sh
source "${SRC_DIR}/ui/background.sh"
# shellcheck source=src/ui/header.sh
source "${SRC_DIR}/ui/header.sh"
# shellcheck source=src/ui/calendar.sh
source "${SRC_DIR}/ui/calendar.sh"
# shellcheck source=src/ui/footer.sh
source "${SRC_DIR}/ui/footer.sh"
# shellcheck source=src/navigation.sh
source "${SRC_DIR}/navigation.sh"
# shellcheck source=src/input.sh
source "${SRC_DIR}/input.sh"

#######################################
# Cleanup handler for terminal restoration
# Called on EXIT, INT, TERM signals
#######################################
_cleanup() {
    cleanup_terminal
}

# Setup cleanup trap
trap _cleanup EXIT INT TERM

#######################################
# Main render function
# Draws all UI components to screen
# Globals:
#   FIRST_RENDER - Tracks if this is initial render
#######################################
render() {
    if ((FIRST_RENDER)); then
        clear
        draw_background
        FIRST_RENDER=0
    fi

    # Move cursor to home position (fast, no clearing)
    tput home

    draw_header
    draw_day_headers
    draw_calendar
    draw_footer
}

#######################################
# Application entry point
# Initializes all systems and runs main loop
#######################################
main() {
    # Initialize holidays system BEFORE setup_terminal (prompts need normal terminal)
    init_holidays

    setup_terminal
    setup_hyprland

    # Show splash unless user configured to skip it
    if [[ "${SKIP_SPLASH}" != "true" ]]; then
        show_splash
    fi

    # Track current year to reload holidays on year change
    local last_year="${CURRENT_YEAR}"

    # Main event loop
    while true; do
        # Reload holidays if year changed
        if [[ "${CURRENT_YEAR}" != "${last_year}" ]]; then
            load_holidays "${CURRENT_YEAR}"
            last_year="${CURRENT_YEAR}"
        fi

        render
        handle_input
    done
}

# Start application
main "$@"
